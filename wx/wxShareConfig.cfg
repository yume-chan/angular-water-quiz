var ghost = require(process.argv[2]+'/webwine/cfg/ghost.js');
var gapi = require(process.argv[2]+'/webwine/cmn/gapi.js');

exports.itfconf = function() {
	return new CurrentAPI().conf();
}

exports.itfleft = function(req,res,fld,fle) {
	return new CurrentAPI().output(req,res,fld,fle);
}

var CurrentAPI = gapi.BaseAPI.extend({
    conf: function() { return { auth: false,
        	type: "json",
        	itfs: [
	            {
	                host: ghost.dscm.winecenter.addr,
	                port: ghost.dscm.winecenter.port,
	                iurl: "/wechatCoreApp?actn=getJSSDKConfig",
	                uuid: "wechatCoreApp",
	                meth: "post",
	                type: "sdcm",
	                next: [],
	                func: function(req,res,fld,fle){
	                	return new CurrentAPI("wechatCoreApp").
	                		callFunc(req,res,fld,fle);
	                }
	            }
        	]
    	};
    },

	doCallFunc: function(uuid, req, res, fld, fle) {
		var url = gapi.getParameter(req, "url");
	    var ip = gapi.getIPv4(req.user.addr);
	    ghost.getLogger().info("[doCallFunc]IP：%s, service: getOpenId, dc: wechatCoreApp.getAccessToken, message: 'param error', param:", ip);
		return {
        	"claz" : "['java.lang.String']",
			"json" : [url]
        };
	},

	doOutput: function(req, res, fld, fle) {
		var ip = gapi.getIPv4(req.user.addr);
		if(!req.rslt['wechatCoreApp']){
			ghost.getLogger().error("[doOutput]IP：%s, service: getOpenId, dc: wechatCoreApp.getAccessToken, message: 'rslt is null', rslt: %s", ip, JSON.stringify(req.rslt['wechatCoreApp']));
		    return gapi.toResult(500, "系统异常");
		}
		if(req.rslt['wechatCoreApp'].code!=0){
        	if(gapi.emptyEqual(req.rslt['wechatCoreApp'].message, "")) {
        		req.rslt['wechatCoreApp'].message = "信息获取失败";
        	}
        	ghost.getLogger().warn("[doOutput]IP：%s, service: getOpenId, dc: wechatCoreApp.getAccessToken, message: 'rslt error', rslt: %s", ip, JSON.stringify(req.rslt['wechatCoreApp']));
        	return gapi.toResult(-1, req.rslt['wechatCoreApp'].message);
        }
  		//ghost.getLogger().info("[doOutput]IP：%s, service: getOpenId, dc: wechatCoreApp.getAccessToken, rslt: %s", ip, JSON.stringify(req.rslt['wechatCoreApp']));
		return gapi.toResult(null,null,req.rslt['wechatCoreApp']);
		// var output={"name":"ff"};
		// return gapi.toResult(200,"",output);
	}
});
